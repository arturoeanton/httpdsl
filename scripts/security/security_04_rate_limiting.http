# Security Demo 4: Rate Limiting and DoS Protection Testing
# Learn to test rate limiting, throttling, and DoS protection mechanisms

print "âš¡ === Security Demo 4: Rate Limiting and DoS Protection Testing ==="
print "Testing rate limiting, throttling, and denial-of-service protection"

set $api_base "https://httpbin.org"
set $test_endpoint "https://jsonplaceholder.typicode.com"

# Test 1: Normal rate testing baseline
print ""
print "ğŸ“Š Test 1: Establishing baseline rate testing..."

set $normal_requests 3
set $request_counter 0
set $successful_requests 0

print "Making $normal_requests normal-rate requests..."

repeat $normal_requests times do
    set $request_counter $request_counter + 1
    print "Normal request #$request_counter..."
    
    GET "$test_endpoint/posts/1"
        header "X-Rate-Test" "baseline"
        header "X-Request-Number" "$request_counter"
        header "X-Client-ID" "security-tester-001"
    
    assert status 200
    set $successful_requests $successful_requests + 1
    
    # Normal delay between requests
    wait 1000 ms
endloop

print "âœ… Baseline test completed: $successful_requests/$normal_requests successful"

# Test 2: Burst request testing
print ""
print "ğŸ’¥ Test 2: Burst request pattern testing..."

set $burst_requests 5
set $burst_counter 0
set $burst_successful 0

print "Testing burst pattern with $burst_requests rapid requests..."

repeat $burst_requests times do
    set $burst_counter $burst_counter + 1
    print "Burst request #$burst_counter..."
    
    GET "$api_base/delay/0"
        header "X-Rate-Test" "burst-pattern"
        header "X-Request-Number" "$burst_counter"
        header "X-Pattern" "rapid-fire"
    
    # Note: We expect these to succeed with httpbin, but we're testing the pattern
    assert status 200
    set $burst_successful $burst_successful + 1
    
    # Minimal delay for burst testing
    wait 100 ms
endloop

print "âœ… Burst pattern tested: $burst_successful/$burst_requests completed"
print "âš ï¸ Note: Production APIs should implement rate limiting for this pattern"

# Test 3: Rate limit header detection
print ""
print "ğŸ“‹ Test 3: Rate limit header detection and monitoring..."

GET "$api_base/response-headers"
    header "X-Rate-Limit-Test" "header-detection"
    header "X-Monitor" "rate-limit-headers"

assert status 200
print "âœ… Rate limit header detection test completed"

# Simulate rate limit header analysis
set $rate_limit_remaining 100
set $rate_limit_window 3600
set $rate_limit_reset_time 1703251200

print "ğŸ“Š Simulated Rate Limit Analysis:"
print "â€¢ Remaining requests: $rate_limit_remaining"
print "â€¢ Time window: $rate_limit_window seconds"
print "â€¢ Reset timestamp: $rate_limit_reset_time"

# Test 4: Throttling behavior simulation
print ""
print "ğŸŒ Test 4: Throttling behavior simulation..."

set $throttle_requests 4
set $throttle_delay 500

print "Testing throttling with $throttle_delay ms delays..."

repeat $throttle_requests times do
    set $throttle_counter $throttle_counter + 1
    print "Throttled request #$throttle_counter with $throttle_delay ms delay..."
    
    GET "$test_endpoint/posts/$throttle_counter"
        header "X-Throttle-Test" "controlled-rate"
        header "X-Delay-Pattern" "progressive"
    
    assert status 200
    extract jsonpath "$.id" as $post_id
    print "Retrieved post ID: $post_id"
    
    # Progressive delay increase
    wait $throttle_delay ms
    set $throttle_delay $throttle_delay + 200
endloop

print "âœ… Throttling simulation completed"

# Test 5: Client identification for rate limiting
print ""
print "ğŸ†” Test 5: Client identification and tracking..."

set $client_types "mobile web api"
set $current_client "mobile"

# Test different client identification methods
if $current_client == "mobile" then
    print "ğŸ“± Testing mobile client rate patterns..."
    GET "$api_base/user-agent"
        header "User-Agent" "MobileApp/1.0 (iOS 17.0)"
        header "X-Client-Type" "mobile"
        header "X-App-Version" "1.0.0"
        header "X-Device-ID" "mobile-device-123"
    
    assert status 200
    set $client_category "mobile"
elif $current_client == "web" then
    set $client_category "web"
else
    set $client_category "api"
endif

print "âœ… Client identification test: $client_category"

# Test 6: Rate limiting bypass prevention
print ""
print "ğŸ”’ Test 6: Rate limiting bypass prevention testing..."

# Test with different IP simulation (headers only - defensive testing)
GET "$test_endpoint/users/1"
    header "X-Forwarded-For" "192.168.1.100"
    header "X-Real-IP" "10.0.0.50"
    header "X-Rate-Bypass-Test" "ip-rotation"
    header "X-Security-Check" "bypass-prevention"

assert status 200
print "âœ… IP rotation pattern tested (defensive check)"

# Test with different User-Agent patterns
repeat 2 times do
    GET "$api_base/headers"
        header "User-Agent" "SecurityTester-Rotation-Pattern"
        header "X-UA-Rotation" "pattern-detection"
    
    assert status 200
    print "User-Agent rotation pattern tested"
    wait 500 ms
endloop

# Test 7: Rate limit recovery testing
print ""
print "ğŸ”„ Test 7: Rate limit recovery and backoff testing..."

set $recovery_delay 2000
print "Testing recovery with $recovery_delay ms backoff..."

# Simulate waiting for rate limit recovery
wait $recovery_delay ms

# Test requests after backoff
GET "$test_endpoint/posts"
    header "X-Recovery-Test" "post-backoff"
    header "X-Backoff-Duration" "$recovery_delay"

assert status 200
extract jsonpath "$[0].id" as $recovered_post_id

if $recovered_post_id > 0 then
    print "âœ… Rate limit recovery successful"
    set $recovery_status "SUCCESS"
else
    print "âš ï¸ Rate limit recovery needs more time"
    set $recovery_status "PARTIAL"
endif

# Rate limiting security summary
print ""
print "ğŸ“Š === Rate Limiting Security Test Summary ==="
print "Baseline Rate Testing: âœ… COMPLETED"
print "Burst Pattern Analysis: âœ… TESTED"
print "Rate Limit Headers: âœ… MONITORED"
print "Throttling Behavior: âœ… SIMULATED"
print "Client Identification: âœ… $client_category"
print "Bypass Prevention: âœ… TESTED"
print "Recovery Testing: $recovery_status"

print ""
print "âš¡ Rate Limiting Best Practices Validated:"
print "â€¢ Proper request spacing and timing"
print "â€¢ Rate limit header monitoring"
print "â€¢ Client identification and categorization"
print "â€¢ Graceful handling of rate limits"
print "â€¢ Progressive backoff strategies"
print "â€¢ Bypass prevention awareness"

print ""
print "ğŸ›¡ï¸ DoS Protection Patterns Tested:"
print "â€¢ Burst request detection"
print "â€¢ Rate limit threshold testing"
print "â€¢ Client behavior analysis"
print "â€¢ Recovery time validation"
print "â€¢ Header-based monitoring"

print ""
print "âš ï¸ Security Recommendations:"
print "â€¢ Implement progressive rate limiting"
print "â€¢ Monitor for unusual request patterns"
print "â€¢ Use multiple identification methods"
print "â€¢ Implement exponential backoff"
print "â€¢ Log and alert on rate limit violations"
print "â€¢ Consider different limits for different endpoints"

print ""
print "ğŸ” Rate Limiting Checklist:"
print "â€¢ âœ… Normal request patterns identified"
print "â€¢ âœ… Burst behavior analyzed"
print "â€¢ âœ… Rate limit headers monitored"
print "â€¢ âœ… Throttling patterns tested"
print "â€¢ âœ… Client identification verified"
print "â€¢ âœ… Recovery mechanisms validated"

print ""
print "âœ… Security Demo 4 completed - Rate limiting and DoS protection!"