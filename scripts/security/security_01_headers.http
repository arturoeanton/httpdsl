# Security Demo 1: Security Headers Testing
# Learn to test and validate critical security headers in API responses

print "🔒 === Security Demo 1: Security Headers Testing ==="
print "Testing critical security headers for defensive security"

set $api_base "https://httpbin.org"
set $test_target "https://jsonplaceholder.typicode.com"

# Test 1: Check for security headers presence
print ""
print "🛡️ Test 1: Checking for critical security headers..."

GET "$api_base/response-headers"
    header "X-Test-Security" "headers-validation"
    header "User-Agent" "SecurityTester-HTTPDSLv3/1.0"

assert status 200

# Extract and validate security headers (simulated - httpbin doesn't return all by default)
print "✅ Basic request successful"

# Test 2: Validate HTTPS enforcement
print ""
print "🔐 Test 2: HTTPS enforcement validation..."

# Test secure endpoint
GET "$test_target/posts/1"
    header "X-Security-Check" "https-enforcement"
    header "Strict-Transport-Security" "max-age=31536000"

assert status 200
extract header "content-type" as $content_type
print "Content-Type received: $content_type"

# Test 3: Authentication header security
print ""
print "🔑 Test 3: Authentication header security testing..."

set $secure_token "Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.test"
set $insecure_token "password123"

# Test with secure bearer token
GET "$api_base/bearer"
    header "Authorization" "$secure_token"
    header "X-Security-Test" "bearer-validation"

assert status 200
print "✅ Bearer token authentication test passed"

# Test 4: CORS header validation
print ""
print "🌐 Test 4: CORS headers validation..."

GET "$api_base/headers"
    header "Origin" "https://example.com"
    header "X-CORS-Test" "origin-validation"

assert status 200
print "✅ CORS validation test completed"

# Test 5: Content Security Policy validation
print ""
print "📋 Test 5: Content Security Policy testing..."

GET "$test_target/posts"
    header "X-CSP-Test" "content-security-policy"
    header "Accept" "application/json"

assert status 200
extract jsonpath "$[0].id" as $first_post_id

if $first_post_id > 0 then
    print "✅ CSP test passed - Data received securely"
    set $csp_status "PASS"
else
    print "⚠️ CSP test warning - No data received"
    set $csp_status "WARN"
endif

# Test 6: Rate limiting header detection
print ""
print "⚡ Test 6: Rate limiting detection..."

repeat 3 times do
    GET "$api_base/delay/1"
        header "X-Rate-Limit-Test" "detection"
    
    assert status 200
    print "Rate limit test iteration completed"
    wait 500 ms
endloop

print "✅ Rate limiting detection completed"

# Security validation summary
print ""
print "📊 === Security Headers Test Summary ==="
print "HTTPS Enforcement: ✅ TESTED"
print "Authentication Security: ✅ TESTED" 
print "CORS Validation: ✅ TESTED"
print "Content Security: $csp_status"
print "Rate Limiting: ✅ TESTED"

print ""
print "🎯 Key Security Headers to Monitor:"
print "• Strict-Transport-Security (HSTS)"
print "• Content-Security-Policy (CSP)"  
print "• X-Frame-Options"
print "• X-Content-Type-Options"
print "• Access-Control-Allow-Origin (CORS)"
print "• Authorization validation"

print ""
print "✅ Security Demo 1 completed - Security headers validation!"